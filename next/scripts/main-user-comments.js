function loadcomment(e,t,o){var n,r,a,s,l,i,c,d,m="";switch(r="/index.php/c/newcommentsbysort/",a="/index.php/common_comments/newcommentsbysort/",o){case"story":commentfolder="/index.php/c",n="/index.php/c/newcomment/"+e+"?v=1";break;case"storyall1":commentfolder="/index.php/",n=r+e+"/1?limit=0&rows=500";break;case"storyall2":commentfolder="/index.php/c",n=r+e+"/2?limit=0&rows=500";break;case"storyall3":commentfolder="/index.php/c",n=r+e+"/3?limit=0&rows=500";break;case"commonall1":commentfolder="/index.php/common_comments",n=a+e+"/1?limit=0&rows=500";break;case"commonall2":commentfolder="/index.php/common_comments",n=a+e+"/2?limit=0&rows=500";break;case"commonall3":commentfolder="/index.php/common_comments",n=a+e+"/3?limit=0&rows=500";break;default:commentfolder="/index.php/common_comments",n="/index.php/common_comments/newcomment/"+e+"?v=1"}var u=new Date;n=n+"&"+(1e8*u.getFullYear()+1e6*(u.getMonth()+1)+1e4*u.getDate()+100*u.getHours()+u.getMinutes()),r=null,a=null,"localhost"===window.location.hostname&&(n="/api/comments/story.json");try{document.getElementById("cstoryid").value=e,window.readingid=e}catch(e){}var p=document.getElementById(t);p.innerHTML="正在获取本文读者评论的数据...";var y=new XMLHttpRequest;y.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var n=JSON.parse(this.responseText),r="";if(n.hot)for(var a=0;a<n.hot.length;a++)m="",s="",r+='<div class="commentcontainer">'+m+'<dt><div class="ding"></div><span>'+n.hot[a].dnewdate+"</span><b>"+n.hot[a].nickname.replace(/<[Aa] .+>(.+)<\/[Aa]>/g,"$1")+s+'</b> <font class="grey">'+n.hot[a].user_area+"</font></dt><dd>"+n.hot[a].quote_content+n.hot[a].talk+'</dd><div class="replybox" id=reh'+n.hot[a].id+"></div><dt class='replycomment'><a href='javascript:cmt_reply(\""+n.hot[a].id+'","h");\'>回复</a> <a id=hst'+n.hot[a].id+" href='javascript:voteComment(\""+n.hot[a].id+'","#hst", "support");\'>支持</a>(<font id=\'hsts'+n.hot[a].id+"' color=#BA2636>"+n.hot[a].support_count+"</font>) <a id=hdt"+n.hot[a].id+" href='javascript:voteComment(\""+n.hot[a].id+'","#hdt","disagree");\'>反对</a>(<font id=\'hdtd'+n.hot[a].id+"'>"+n.hot[a].disagree_count+"</font>)</dt></div>";for(var u=0;u<n.result.length;u++)s="",m="",r+="<div class=commentcontainer>"+m+"<dt><span>"+n.result[u].dnewdate+"</span><b>"+n.result[u].nickname.replace(/<[Aa] .+>(.+)<\/[Aa]>/g,"$1")+s+"</b> <font class=grey>"+n.result[u].user_area+"</font><div class=clearfloat></div></dt><dd>"+n.result[u].quote_content+n.result[u].talk+"</dd><div class=replybox id=re"+n.result[u].id+"></div><dt class=replycomment><a href='javascript:cmt_reply(\""+n.result[u].id+'","");\'>回复</a> <a id=st'+n.result[u].id+" href='javascript:voteComment(\""+n.result[u].id+'","#st","support");\'>支持</a>(<font id=\'sts'+n.result[u].id+"'>"+n.result[u].support_count+"</font>) <a id=dt"+n.result[u].id+" href='javascript:voteComment(\""+n.result[u].id+'","#dt","disagree");\'>反对</a>(<font id=\'dtd'+n.result[u].id+"'>"+n.result[u].disagree_count+"</font>)</dt></div>",window.unusedEntryIndex=u;p.innerHTML=r,n.count&&n.count>0||"story"!==o?(init_repeat_cmt(),(n.count>20||n.result.length>20)&&(l=n.count||n.result.length,c=o.indexOf("story")>=0?"story":"common",i=o.indexOf("storyall")>=0?o.replace(/storyall/g,""):1,p.innerHTML+="<div class=fullcomments><span class=viewfullcomments id=viewfullcomments>查看全部<span class=highlight>"+l+'</span>条评论 </span><select class=commentsortby id=commentsortby value="'+i+'"><option value=1 selected>最新的在上方</option><option value=2>最早的在上方</option><option value=3>按热门程度</option></select></div>',document.getElementById("viewfullcomments").onclick=function(){d=document.getElementById("commentsortby").value,loadcomment(e,t,c+"all"+d)},document.getElementById("commentsortby").onchange=function(){d=document.getElementById("commentsortby").value,loadcomment(e,t,c+"all"+d)})):p.innerHTML=""}else p.innerHTML="<span class='error'>很抱歉。由于您与FT服务器之间的连接发生故障，加载评论内容失败。请稍后再尝试。</span>"},y.open("GET",n,!0),y.send()}function init_repeat_cmt(){for(var e,t=document.querySelectorAll(".cmt_quote"),o=0;o<t[o];o++)"DD"===t[o].parentNode.tagName.toUpperCase()?(t[o].id="cmt_quote_"+Math.round(1e6*Math.random()),"cmt_quote"===t[o].childNodes[0].className&&(t[o].childNodes[0].id="cmt_quote_child_"+Math.round(1e6*Math.random()))):"recommendcomment"!==t[o].id&&(t[o].style.display="none");for(var n=document.querySelectorAll('div[id^="cmt_quote_child_"]'),r=0;r<n.length;r++)n[r].style.display="","cmt_quote"===n[r].childNodes[0].className&&(e=document.querySelectorAll("#"+n[r].id+" .cmt_quote").length,document.getElementById(n[r].id).innerHTML="<p onclick=\"showcmt(this)\" class='showcmt'>重复 [ "+e+" ] 条引用已被隐藏,点击展开。</p>"+document.getElementById(n[r].id).innerHTML)}function showcmt(e){document.querySelector("#"+e.parentNode.id+" .cmt_quote").style.display="",e.style.display="none"}function voteComment(e,t,o){t||(t="support"===o?"#st":"#dt");var n=document.querySelector(t+o[0]+e).innerHTML;n=parseInt(n,10)||0,document.querySelector(t+o[0]+e).innerHTML=n+1,document.querySelector(t+e).removeAttribute("href"),document.querySelector(t+e).innerHTML="support"===o?"已支持":"已反对";var r="cmtid="+e+"&action="+o,a=new XMLHttpRequest;a.open("POST",commentfolder+"/addvote/"),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(r)}function cmt_reply(e,t){var o,n;t=t||"";for(var r=document.querySelectorAll(".replybox"),a=0;a<r.length;a++)r[a].innerHTML="";username?(document.querySelector("#re"+t+e).innerHTML='<div id=reply-input-container><b>回复此评论：</b><textarea id="replycontent" class="commentTextArea" rows="3"></textarea><span style="display:none;"><input name="use_nicknamer" type="radio" id="namer" onclick="unuseitr(this);"/><label for="namer">匿名</label><input name="use_nicknamer" type="radio" id="useridr" value="0" onclick="useitr(this);" checked/><label for="useridr">昵称</label> <input type="text" class="user_id textinput" id="nick_namer" value="" /></span><input type="button" value="提交回复" class="comment_btn submitbutton button ui-light-btn" id="addnewcommentr"/></div>',document.querySelector("#nick_namer").value=document.querySelector("#nick_name").value,document.querySelector("#addnewcommentr").onclick=function(){n=0;var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var o=this.responseText;if("yes"!==o)return void presentAlert("非常抱歉，现在我们的网站遇到一些技术故障。您的留言可能没有发表成功，稍后请您试着重新发表一次。","");document.querySelector("#re"+t+e).innerHTML="",presentAlert("感谢您的参与，您的评论内容已经提交。审核后会立即显示出来！","")}else document.querySelector("#re"+t+e).innerHTML="",presentAlert("很抱歉。由于您的网络的连接发生故障，发表评论失败。稍后请您试着重新发表一次。","")};var r="storyid="+window.readingid+"&topic_object_id="+window.readingid+"&talk="+document.querySelector("#replycontent").value+"&use_nickname="+n+"&NickName="+document.querySelector("#nick_namer").value+"&cmtid="+e+"&type="+t+"&title=&url=";o.open("POST",commentfolder+"/add"),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(r),this.disabled=!0}):(o=document.querySelector("#nologincomment").innerHTML.replace(/username1/g,"username2").replace(/password1/g,"password2").replace(/login\(1\)/g,"login(2)"),document.querySelector("#re"+t+e).innerHTML=o)}function clickToSubmitComment(){document.querySelector("#addnewcomment").onclick=function(){var e=document.querySelectorAll("#name").checked?1:0;console.log("clicked comments"),this.value="正在发布中...",this.disabled=!0;var t=new XMLHttpRequest;t.onreadystatechange=function(){if(4===this.readyState){if("yes"!==this.responseText)return void presentAlert("抱歉,现在我们的网站可能出现了一些小故障.您的留言可能没有发表成功,请您稍后再重新尝试发表一次。","");presentAlert("感谢您的参与，您的评论内容已经发表成功。审核后就会立即显示!",""),document.querySelector("#addnewcomment").value="提交评论",document.querySelector("#addnewcomment").disabled=!1,document.querySelector("#Talk").value=""}};var o;o=/^[0-9]+$/.test(window.FTStoryid)?"storyid="+window.FTStoryid+"&talk="+document.querySelector("#Talk").value+"&use_nickname="+e+"&NickName="+document.querySelector("#nick_name").value:"topic_object_id="+window.FTStoryid+"&talk="+document.querySelector("#Talk").value+"&use_nickname="+e+"&NickName="+document.querySelector("#nick_name").value+"&type=video",t.open("POST",commentfolder+"/add"),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(o)}}function login(e){function t(e){var t={action:"login",userId:e};try{webkit?webkit.messageHandlers.login.postMessage(t):Android&&Android.onPageLoaded(JSON.stringify(t))}catch(e){}}var o,n,r;void 0!==e?(o=document.querySelector("#username"+e).value,n=document.querySelector("#password"+e).value):(o=document.querySelector("#username").value,n=document.querySelector("#password").value);var a=document.querySelectorAll(".statusmsg");for(r=0;r<a.length;r++)a[r].innerHTML="正在登录中...";var s=new XMLHttpRequest;s.onreadystatechange=function(){var e;if(4===this.readyState)if(200===this.status){var n,r=JSON.parse(this.responseText);if(r.status&&"ok"===r.status){for(e=0;e<a.length;e++)a[e].innerHTML="登录成功！";for(var s=document.querySelectorAll(".logincomment, .logincommentc, .nologincomment, .nologincommentc, .logged, .notLogged"),l=0;l<s.length;l++)s[l].style.display="none";var i=document.querySelectorAll(".nick_name,.user_id,.user_Name");for(e=0;e<i;e++)i[e].value=o,i[e].innerHTML=o;var c=document.querySelectorAll(".logincomment, .logincommentc, .logged");for(n=0;n<c.length;n++)c[n].style.display="block";for(username=o,void 0!==window.userId&&""!==window.userId||(window.userId=GetCookie("USER_ID")||""),e=0;e<a.length;e++)a[e].innerHTML="";checkLogin(),t()}else for(e=0;e<a.length;e++)a[e].innerHTML='<div class="highlight">'+r.msg+"</div>"}else for(e=0;e<a.length;e++)a[e].innerHTML='<div class="highlight">对不起，网络故障。请过一段时间再重新尝试。</div>'};var l="username="+o+"&password="+n+"&saveme=1",i=parseInt(1e6*Math.random(),10);s.open("POST","/index.php/users/login/ajax?"+i),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.send(l)}function socialLogin(e,t){var o="/index.php/users/socialLogin/"+e,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var e=this.responseText;if("yes"===e)return presentAlert("微信登陆成功",""),username=GetCookie("USER_NAME")||GetCookie("USER_NAME_FT")||"",void checkLogin();presentAlert("登录失败",e+"亲爱的用户，由于FT中文网的服务器未能正确响应，所以您未能成功登录。请稍后再试，或尝试其他登录方式。")}else presentAlert("登录失败","亲爱的用户，由于FT中文网的服务器未能正确响应，所以您未能成功登录。请稍后再试，或尝试其他登录方式。")};var r="socialInfo="+t,a=parseInt(1e6*Math.random(),10);n.open("POST",o+"?"+a),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(r)}function logout(){for(var e=document.querySelectorAll(".logged .statusmsg"),t=0;t<e.length;t++)e[t].innerHTML="正在登出...";var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===this.readyState&&200===this.status){for(var e=document.querySelectorAll(".logincomment,.nologincomment, .logged, .notLogged"),t=0;t<e.length;t++)e[t].style.display="none";for(var o=document.querySelectorAll(".nologincomment,.notLogged"),n=0;n<o.length;n++)o[n].style.display="block";window.username="",checkLogin()}},o.onerror=function(){checkLogin(),console.log("something went wrong. but we check login any way. ")};var n=parseInt(1e6*Math.random(),10);o.open("GET","/index.php/users/logout?"+n),o.send();try{if(webkit){var r={action:"logout",href:location.href};webkit.messageHandlers.logout.postMessage(r)}}catch(e){}}function checkLogin(){window.username=GetCookie("USER_NAME")||GetCookie("USER_NAME_FT"),window.userId=GetCookie("USER_ID");var e,t=document.querySelectorAll(".logincomment, .nologincomment, .logged, .notLogged");for(e=0;e<t.length;e++)t[e].style.display="none";var o=document.querySelectorAll(".logged .statusmsg");for(e=0;e<o.length;e++)o[e].innerHTML="";if(username){for(var n=document.querySelectorAll(".nick_name,.user_id,.user_Name"),r=0;r<n.length;r++)n[r].value=window.username,n[r].innerHTML=window.username;for(var a=document.querySelectorAll(".logincomment,.logged"),s=0;s<a.length;s++)a[s].style.display="block"}else{document.querySelector("#nick_name").value="";for(var l=document.querySelectorAll(".nologincomment,.notLogged"),i=0;i<l.length;i++)l[i].style.display="block"}passLoginToNative()}function presentAlert(e,t){var o={title:e,message:t};try{webkit.messageHandlers.alert.postMessage(o)}catch(e){}}function passLoginToNative(){var e={},t=GetCookie("uniqueVisitorId")||guid(),o=GetCookie("USER_NAME")||GetCookie("USER_NAME_FT")||"",n=GetCookie("USER_ID")||"",r=GetCookie("paywall_source")||"";e={username:o,userId:n,uniqueVisitorId:t,ccode:GetCookie("ccode")||"",source:r};var a=GetCookie("paywall")||"",s=GetCookie("paywall_expire")||"";""!==a&&(e.paywall=a),""!==s&&(e.paywallExpire=s);try{webkit.messageHandlers.user.postMessage(e)}catch(e){}if(""!==n){var l=new XMLHttpRequest;l.open("GET","/index.php/jsapi/paywall"),l.setRequestHeader("Content-Type","application/json"),l.onload=function(){if(200===l.status){var t=JSON.parse(l.responseText);window.htmlClass=document.documentElement.className,window.htmlClass=window.htmlClass.replace(/\ is\-subscriber/g,"").replace(/\ is\-premium/g,"").replace(/\ is\-standard/g,""),0===t.paywall?(1===t.premium?(e.paywall="premium",window.htmlClass+=" is-subscriber is-premium"):(e.paywall="standard",window.htmlClass+=" is-subscriber is-standard"),e.paywallExpire=t.expire||"",document.documentElement.className=window.htmlClass):(e.paywall="",e.paywallExpire=""),e.ccode=t.campaign_code||"",e.duration=t.latest_duration||"",e.source=t.source||"";try{webkit.messageHandlers.user.postMessage(e)}catch(e){}console.log("save User expire: "+t.expire),SetCookie("paywall_expire",t.expire,864e4,"/"),SetCookie("paywall",e.paywall,864e4,"/"),SetCookie("paywall_source",e.source,864e4,"/"),console.log("get User expire: "+GetCookie("paywall_expire"))}},l.send()}}var commentfolder="/index.php/comments";try{passLoginToNative()}catch(e){}